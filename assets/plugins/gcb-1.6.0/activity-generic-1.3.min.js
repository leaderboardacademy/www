function getFreshTag(){return globallyUniqueTag++,globallyUniqueTag}function gcbTagEventAudit(a,b){gcbAudit(gcbCanPostTagEvents,a,"tag-"+b,!0)}function gcbPageEventAudit(a,b){gcbAudit(gcbCanPostPageEvents,a,b,!1)}function gcbActivityAudit(a){gcbAudit(gcbCanPostEvents,a,"attempt-activity",!0)}function gcbLessonAudit(a){gcbAudit(gcbCanPostEvents,a,"attempt-lesson",!0)}function gcbAssessmentAudit(a){gcbAudit(gcbCanPostEvents,a,"attempt-assessment",!0)}function gcbAudit(a,b,c,d){if(a){b.location=""+window.location;var e={source:c,payload:JSON.stringify(b),xsrf_token:eventXsrfToken};$.ajax({url:"rest/events",type:"POST",async:d,data:{request:JSON.stringify(e)},success:function(){},error:function(){}})}if("dataLayer"in window){switch(c){case"enter-page":case"exit-page":c="page."+c;break;default:c="event."+c}c="gcb."+c;var f={};$.extend(f,b,{event:c,is_async:d}),dataLayer.push(f)}}function getParamFromUrlByName(a){return decodeURI((RegExp(a+"="+"(.+?)(&|$)").exec(location.search)||[,null])[1])}function generateMultipleChoiceQuestion(a,b,c){var d=a.choices,e=getFreshTag(),f="q"+e;"questionHTML"in a&&b.append(a.questionHTML),$.each(d,function(a,c){var d=c[0],g=c[1],h=f+"-"+a;g?b.append('<span class="correct_'+e+'">'+'<input type="radio" name="'+f+'" '+'id="'+h+'" value="correct"> '+'<label for="'+h+'">'+d+"</label></span>"):b.append('<input type="radio" name="'+f+'" '+'id="'+h+'"> '+'<label for="'+h+'">'+d+"</label>"),b.append("<br>")}),b.append("<br>"),b.append('<p/><button class="gcb-button" id="submit_'+e+'">'+trans.CHECK_ANSWER_TEXT+"</button>"),b.append('<p/><textarea style="width: 600px; height: 50px;" readonly="true" id="output_'+e+'"></textarea>');var g=$("input[name="+f+"]");g.click(function(){$(".correct_"+e).css("background-color",""),$("#output_"+e).val("")}),$("#submit_"+e).keydown(function(a){13===a.keyCode&&($(this).trigger("click",!0),a.preventDefault())}),$("#submit_"+e).click(function(){for(var a=!1,b=0;b<g.length;b++){var f=d[b][1],h=d[b][2],i=g[b].checked;i&&(gcbActivityAudit({index:c,type:"activity-choice",value:b,correct:f}),$("#output_"+e).val(h),$("#output_"+e).focus(),f&&$(".correct_"+e).css("background-color",highlightColor),a=!0)}a||($("#output_"+e).val(trans.SELECT_ANSWER_PROMPT),$("#output_"+e).focus())})}function generateMultipleChoiceGroupQuestion(a,b,c){var d=a.questionsList,e=a.allCorrectOutput,f=a.someIncorrectOutput,g=[];"questionGroupHTML"in a&&b.append(a.questionGroupHTML);var h=d.length;if("allCorrectMinCount"in a){var i=a.allCorrectMinCount;i>=0&&i<=d.length&&(h=i)}var j=function(a){if(a.correctIndex instanceof Array){var b=a.correctIndex.length;return"multiSelect"in a&&!a.multiSelect?1:b}return 1},k=function(a,b){return a.correctIndex instanceof Array?-1!=$.inArray(b,a.correctIndex):b==a.correctIndex};$.each(d,function(a,c){var d=getFreshTag();g.push(d);var e="q"+d,f="radio";c.correctIndex instanceof Array&&c.correctIndex.length>1&&(f="checkbox"),"multiSelect"in c&&!c.multiSelect&&(f="radio"),b.append(c.questionHTML),b.append("<br>"),$.each(c.choices,function(g,h){var i=e+"-"+a+"-"+g;k(c,g)?b.append('<span class="correct_'+d+'">'+'<input type="'+f+'" name="'+e+'" '+'id="'+i+'" value="correct"> '+'<label for="'+i+'">'+h+"</label></span>"):b.append('<input type="'+f+'" name="'+e+'" '+'id="'+i+'"> '+'<label for="'+i+'">'+h+"</label>"),b.append("<br>")}),b.append("<p/>")});var l=getFreshTag();b.append('<p/><button class="gcb-button" id="submit_'+l+'">'+trans.CHECK_ANSWERS_TEXT+"</button>"),b.append('<p/><textarea style="width: 600px; height: 100px;" readonly="true" id="output_'+l+'"></textarea>'),$.each(d,function(a){var c=g[a],d="q"+c,e=$("input[name="+d+"]");e.click(function(){$.each(g,function(a,b){$(".correct_"+b).css("background-color","")}),$("#output_"+l).val("")})}),$("#submit_"+l).keydown(function(a){13===a.keyCode&&($(this).trigger("click",!0),a.preventDefault())}),$("#submit_"+l).click(function(){var a=0,b=0;if(answers=[],$.each(d,function(a,c){for(var d=g[a],e="q"+d,f=$("input[name="+e+"]"),h=0,i=0,l=[],m=0;m<f.length;m++){var n=f[m].checked,o=k(c,m);n&&(h++,o&&i++,l.push(m))}var p=!1;h==i&&i==j(c)&&(b++,p=!0),answers.push({index:a,value:l,correct:p})}),gcbActivityAudit({index:c,type:"activity-group",values:answers,num_expected:h,num_submitted:a,num_correct:b}),b>=h){var i=trans.ALL_CORRECT_TEXT;b<d.length&&(i=trans.NUM_CORRECT_TEXT+": "+b+"/"+d.length+". "),$.each(g,function(a,b){$(".correct_"+b).css("background-color",highlightColor)}),$("#output_"+l).val(i+" "+e),$("#output_"+l).focus()}else $("#output_"+l).val(trans.NUM_CORRECT_TEXT+": "+b+"/"+d.length+".\n\n"+f),$("#output_"+l).focus()})}function generateFreetextQuestion(a,b,c){var d=a.correctAnswerRegex,e=a.correctAnswerOutput,f=a.incorrectAnswerOutput,g=a.showAnswerOutput,h=a.showAnswerPrompt||trans.SHOW_ANSWER_TEXT,i=a.outputHeight||"50px",j=getFreshTag();"questionHTML"in a&&b.append(a.questionHTML),b.append('&nbsp;&nbsp;<input type="text" style="width: 400px; class="alphanumericOnly" id="input_'+j+'">'),e&&f&&b.append('<p/><button class="gcb-button" id="submit_'+j+'">'+trans.CHECK_ANSWER_TEXT+"</button>"),g&&b.append('<p/><button class="gcb-button" id="skip_and_show_'+j+'">'+h+"</button>"),b.append('<p/><textarea style="width: 600px; height: '+i+';" '+'readonly="true" id="output_'+j+'"></textarea>'),$("#input_"+j).focus(function(){$("#output_"+j).val("")}),e&&f&&($("#submit_"+j).keydown(function(a){13===a.keyCode&&($(this).trigger("click",!0),a.preventDefault())}),$("#submit_"+j).click(function(){var a=$("#input_"+j).val();a=a.replace(/^\s+/,""),a=a.replace(/\s+$/,"");var b=d.test(a);gcbActivityAudit({index:c,type:"activity-freetext",value:a,correct:b}),b?($("#output_"+j).val(e),$("#output_"+j).focus()):($("#output_"+j).val(f),$("#output_"+j).focus())})),g&&$("#skip_and_show_"+j).click(function(){var a=$("#input_"+j).val();gcbActivityAudit({index:c,type:"activity-freetext",value:a,correct:null}),$("#output_"+j).val(g),$("#output_"+j).focus()})}function renderActivity(a,b){$.each(a,function(a,c){"string"==typeof c?b.append(c):"multiple choice"==c.questionType?generateMultipleChoiceQuestion(c,b,a):"multiple choice group"==c.questionType?generateMultipleChoiceGroupQuestion(c,b,a):"freetext"==c.questionType?generateFreetextQuestion(c,b,a):alert("Error in renderActivity: e.questionType is not in {'multiple choice', 'multiple choice group', 'freetext'}")})}function renderAssessment(a,b){function f(b){$("#answerOutput").html("");var c=0,d=[],e=[],f=[],g=0,h=0;$.each(a.questionsList,function(a,b){var i=0,j=!1,k=b.weight||1;if(h+=k,b.choices){for(var l=!1,m=document.assessment["q"+a],n=0;n<m.length;n++)if(m[n].checked){j="correct"==m[n].value,b.choiceScores&&b.choiceScores.length==m.length?i=b.choiceScores[n]:j&&(i=1,c++),l=!0,f.push({index:a,type:"choices",value:n,correct:j});break}l||f.push({index:a,type:"choices",value:null,correct:j})}else if(b.correctAnswerString){var o=$("#q"+a).val();o=o.replace(/^\s+/,""),o=o.replace(/\s+$/,""),j=o.toLowerCase()==b.correctAnswerString.toLowerCase(),j&&(i=1,c++),f.push({index:a,type:"string",value:o,correct:j})}else if(b.correctAnswerRegex){var o=$("#q"+a).val();o=o.replace(/^\s+/,""),o=o.replace(/\s+$/,""),j=b.correctAnswerRegex.test(o),j&&(i=1,c++),f.push({index:a,type:"regex",value:o,correct:j})}else if(b.correctAnswerNumeric){var p=parseFloat($("#q"+a).val()),q=.001;b.correctAnswerNumeric-q<=p&&p<=b.correctAnswerNumeric+q&&(j=!0,i=1,c++),f.push({index:a,type:"numeric",value:p,correct:j})}d.push(i*k),g+=i*k,!j&&b.lesson&&e.push(b.lesson)});var i=a.questionsList.length,j=(100*(g/h)).toFixed(2),k=getParamFromUrlByName("name")||"unnamed assessment",l=!b&&assessmentGlobals.isReviewForm;if((assessmentGlobals.isReviewForm||"human"!=assessmentGlobals.grader||window.confirm(trans.SUBMIT_ASSIGNMENT_CONFIRMATION+trans.CONFIRMATION_EXPLANATION))&&(!assessmentGlobals.isReviewForm||l||window.confirm(trans.SUBMIT_REVIEW_CONFIRMATION+trans.CONFIRMATION_EXPLANATION)))if(b||l){var m=document.createElement("form");m.method="post",m.action=assessmentGlobals.isReviewForm?"review":"answer";var n=null;n=document.createElement("input"),n.setAttribute("name","assessment_type"),n.setAttribute("value",k),m.appendChild(n),n=document.createElement("input"),n.setAttribute("name","score"),n.setAttribute("value",j),m.appendChild(n),n=document.createElement("input"),n.setAttribute("name","answers"),n.setAttribute("value",JSON.stringify(f)),m.appendChild(n),n=document.createElement("input"),n.setAttribute("name","xsrf_token"),n.setAttribute("value",assessmentXsrfToken),m.appendChild(n),assessmentGlobals.isReviewForm&&(n=document.createElement("input"),n.setAttribute("name","key"),n.setAttribute("value",assessmentGlobals.key),m.appendChild(n),n=document.createElement("input"),n.setAttribute("name","unit_id"),n.setAttribute("value",assessmentGlobals.unitId),m.appendChild(n),n=document.createElement("input"),n.setAttribute("name","is_draft"),n.setAttribute("value",l),m.appendChild(n)),document.body.appendChild(m),m.submit(),document.body.removeChild(m)}else{gcbAssessmentAudit({type:"assessment-"+k,values:f,num_expected:i,num_submitted:f.length,num_correct:c});var o=trans.YOUR_SCORE_TEXT+" "+j+"% ("+g.toFixed(0)+"/"+h+").\n\n";e.length>0&&(o+=trans.LESSONS_TO_REVIEW_TEXT+": "+e.join(", ")+"\n\n"),o+=j>=100?trans.PERFECT_SCORE_SAVE_TEXT:trans.GENERIC_SAVE_TEXT,$("#answerOutput").html(o)}}b.html('<form name="assessment"></form>'),b=b.find("form"),a.preamble&&b.append(a.preamble);var c=$("<ol></ol>");if(b.append(c),$.each(a.questionsList,function(a,b){c.append("<li></li>");var d=c.find("li:last");d.append(b.questionHTML),d.append("<p/>");var e=null;if(assessmentGlobals.savedAnswers&&a<assessmentGlobals.savedAnswers.length&&(e=assessmentGlobals.savedAnswers[a]),b.choices)$.each(b.choices,function(b,c){var f="q"+a+"-"+b,g="";null!==e&&b==e&&(g=" checked=true "),"string"==typeof c?d.append('<input type="radio" name="q'+a+'" id="'+f+'" '+g+' >&nbsp;<label for="'+f+'">'+c+"</label><br>"):("correct"!=c[0]&&alert("Error: Malformed question."),d.append('<input type="radio" name="q'+a+'" id="'+f+'" '+g+' value="correct">&nbsp;<label for="'+f+'">'+c[1]+"</label><br>"))});else if(b.correctAnswerString||b.correctAnswerRegex||b.correctAnswerNumeric)if("multiLine"in b&&b.multiLine){d.append("Answer:<br>");var f=$('<textarea id="q'+a+'" style="width: 100%" rows="7"></textarea>');null!=e&&f.text(e),d.append(f)}else{d.append("Answer:&nbsp;&nbsp;");var g=$('<input type="text" class="alphanumericOnly" style="border-style: solid; border-color: black; border-width: 1px;" id="q'+a+'" size="50">');null!==e&&g.val(e),d.append(g)}else alert("Error: Invalid question type.");d.append("<br><br>")}),assessmentGlobals.isReviewForm)b.append('<br><button type="button" class="gcb-button" id="saveDraftBtn">'+trans.SAVE_DRAFT_TEXT+"</button>&nbsp;&nbsp;"+'<button type="button" class="gcb-button" id="submitAnswersBtn">'+trans.SUBMIT_REVIEW_TEXT+"</button>");else{a.checkAnswers&&(b.append('<button type="button" class="gcb-button" id="checkAnswersBtn">'+trans.CHECK_ANSWERS_TEXT+"</button><p/>"),b.append('<p/><textarea style="width: 600px; height: 120px;" readonly="true" id="answerOutput"></textarea>'));var d=trans.SUBMIT_ANSWERS_TEXT;"human"==assessmentGlobals.grader&&(d=trans.SUBMIT_ASSIGNMENT_TEXT);var e=transientStudent?' disabled="true" ':"";b.append('<br><button type="button" class="gcb-button" id="submitAnswersBtn" '+e+">"+d+"</button>")}$("#checkAnswersBtn").click(function(){f(!1)}),$("#saveDraftBtn").click(function(){f(!1)}),$("#submitAnswersBtn").click(function(){f(!0)})}function correct(a){return["correct",a]}function checkText(a,b){var c=document.getElementById(a).value;return c=c.replace(/^\s+/,""),c=c.replace(/\s+$/,""),b.test(c)}var gcbBeginningOfTime=new Date,highlightColor="#3BB9FF",globallyUniqueTag=0,gcbCanPostTagEvents=!1,gcbCanPostPageEvents=!1,gcbCanPostEvents=!1,eventXsrfToken="",assessmentXsrfToken="";$(document).ready(function(){function c(a){var a=a||event||null,b=a.target||a.srcElement||null;return 13==a.keyCode&&"text"==b.type?!1:void 0}try{gcbPageEventAudit({},"enter-page")}catch(a){}if($("#lessonNotesLink").click(function(a){return gcbPageEventAudit({href:a.target.href},"click-link"),!0}),"undefined"!=typeof activity){var b=$("#activityContents");b.length&&renderActivity(activity,b)}else"undefined"!=typeof assessment&&renderAssessment(assessment,$("#assessmentContents"));$(document).keypress(c)}),$(window).unload(function(){try{gcbPageEventAudit({duration:new Date-gcbBeginningOfTime},"exit-page")}catch(a){}});