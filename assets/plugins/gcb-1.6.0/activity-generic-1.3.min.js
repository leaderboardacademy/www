function getFreshTag(){return globallyUniqueTag++,globallyUniqueTag}function gcbTagEventAudit(e,t){gcbAudit(gcbCanPostTagEvents,e,"tag-"+t,!0)}function gcbPageEventAudit(e,t){gcbAudit(gcbCanPostPageEvents,e,t,!1)}function gcbActivityAudit(e){gcbAudit(gcbCanPostEvents,e,"attempt-activity",!0)}function gcbLessonAudit(e){gcbAudit(gcbCanPostEvents,e,"attempt-lesson",!0)}function gcbAssessmentAudit(e){gcbAudit(gcbCanPostEvents,e,"attempt-assessment",!0)}function gcbAudit(e,t,n,r){if(e){t.location=""+window.location;var s={source:n,payload:JSON.stringify(t),xsrf_token:eventXsrfToken};$.ajax({url:"rest/events",type:"POST",async:r,data:{request:JSON.stringify(s)},success:function(){},error:function(){}})}if("dataLayer"in window){switch(n){case"enter-page":case"exit-page":n="page."+n;break;default:n="event."+n}n="gcb."+n;var a={};$.extend(a,t,{event:n,is_async:r}),dataLayer.push(a)}}function getParamFromUrlByName(e){return decodeURI((RegExp(e+"=(.+?)(&|$)").exec(location.search)||[,null])[1])}function generateMultipleChoiceQuestion(e,t,n){var r=e.choices,s=getFreshTag(),a="q"+s;"questionHTML"in e&&t.append(e.questionHTML),$.each(r,function(e,n){var r=n[0],i=n[1],c=a+"-"+e;t.append(i?'<span class="correct_'+s+'"><input type="radio" name="'+a+'" id="'+c+'" value="correct"> <label for="'+c+'">'+r+"</label></span>":'<input type="radio" name="'+a+'" id="'+c+'"> <label for="'+c+'">'+r+"</label>"),t.append("<br>")}),t.append("<br>"),t.append('<p/><button class="gcb-button" id="submit_'+s+'">'+trans.CHECK_ANSWER_TEXT+"</button>"),t.append('<p/><textarea style="width: 600px; height: 50px;" readonly="true" id="output_'+s+'"></textarea>');var i=$("input[name="+a+"]");i.click(function(){$(".correct_"+s).css("background-color",""),$("#output_"+s).val("")}),$("#submit_"+s).keydown(function(e){13===e.keyCode&&($(this).trigger("click",!0),e.preventDefault())}),$("#submit_"+s).click(function(){for(var e=!1,t=0;t<i.length;t++){var a=r[t][1],c=r[t][2],o=i[t].checked;o&&(gcbActivityAudit({index:n,type:"activity-choice",value:t,correct:a}),$("#output_"+s).val(c),$("#output_"+s).focus(),a&&$(".correct_"+s).css("background-color",highlightColor),e=!0)}e||($("#output_"+s).val(trans.SELECT_ANSWER_PROMPT),$("#output_"+s).focus())})}function generateMultipleChoiceGroupQuestion(e,t,n){var r=e.questionsList,s=e.allCorrectOutput,a=e.someIncorrectOutput,i=[];"questionGroupHTML"in e&&t.append(e.questionGroupHTML);var c=r.length;if("allCorrectMinCount"in e){var o=e.allCorrectMinCount;o>=0&&o<=r.length&&(c=o)}var u=function(e){if(e.correctIndex instanceof Array){var t=e.correctIndex.length;return"multiSelect"in e&&!e.multiSelect?1:t}return 1},l=function(e,t){return e.correctIndex instanceof Array?-1!=$.inArray(t,e.correctIndex):t==e.correctIndex};$.each(r,function(e,n){var r=getFreshTag();i.push(r);var s="q"+r,a="radio";n.correctIndex instanceof Array&&n.correctIndex.length>1&&(a="checkbox"),"multiSelect"in n&&!n.multiSelect&&(a="radio"),t.append(n.questionHTML),t.append("<br>"),$.each(n.choices,function(i,c){var o=s+"-"+e+"-"+i;t.append(l(n,i)?'<span class="correct_'+r+'"><input type="'+a+'" name="'+s+'" id="'+o+'" value="correct"> <label for="'+o+'">'+c+"</label></span>":'<input type="'+a+'" name="'+s+'" id="'+o+'"> <label for="'+o+'">'+c+"</label>"),t.append("<br>")}),t.append("<p/>")});var p=getFreshTag();t.append('<p/><button class="gcb-button" id="submit_'+p+'">'+trans.CHECK_ANSWERS_TEXT+"</button>"),t.append('<p/><textarea style="width: 600px; height: 100px;" readonly="true" id="output_'+p+'"></textarea>'),$.each(r,function(e){var t=i[e],n="q"+t,r=$("input[name="+n+"]");r.click(function(){$.each(i,function(e,t){$(".correct_"+t).css("background-color","")}),$("#output_"+p).val("")})}),$("#submit_"+p).keydown(function(e){13===e.keyCode&&($(this).trigger("click",!0),e.preventDefault())}),$("#submit_"+p).click(function(){var e=0,t=0;if(answers=[],$.each(r,function(e,n){for(var r=i[e],s="q"+r,a=$("input[name="+s+"]"),c=0,o=0,p=[],d=0;d<a.length;d++){var b=a[d].checked,m=l(n,d);b&&(c++,m&&o++,p.push(d))}var g=!1;c==o&&o==u(n)&&(t++,g=!0),answers.push({index:e,value:p,correct:g})}),gcbActivityAudit({index:n,type:"activity-group",values:answers,num_expected:c,num_submitted:e,num_correct:t}),t>=c){var o=trans.ALL_CORRECT_TEXT;t<r.length&&(o=trans.NUM_CORRECT_TEXT+": "+t+"/"+r.length+". "),$.each(i,function(e,t){$(".correct_"+t).css("background-color",highlightColor)}),$("#output_"+p).val(o+" "+s),$("#output_"+p).focus()}else $("#output_"+p).val(trans.NUM_CORRECT_TEXT+": "+t+"/"+r.length+".\n\n"+a),$("#output_"+p).focus()})}function generateFreetextQuestion(e,t,n){var r=e.correctAnswerRegex,s=e.correctAnswerOutput,a=e.incorrectAnswerOutput,i=e.showAnswerOutput,c=e.showAnswerPrompt||trans.SHOW_ANSWER_TEXT,o=e.outputHeight||"50px",u=getFreshTag();"questionHTML"in e&&t.append(e.questionHTML),t.append('&nbsp;&nbsp;<input type="text" style="width: 400px; class="alphanumericOnly" id="input_'+u+'">'),s&&a&&t.append('<p/><button class="gcb-button" id="submit_'+u+'">'+trans.CHECK_ANSWER_TEXT+"</button>"),i&&t.append('<p/><button class="gcb-button" id="skip_and_show_'+u+'">'+c+"</button>"),t.append('<p/><textarea style="width: 600px; height: '+o+';" readonly="true" id="output_'+u+'"></textarea>'),$("#input_"+u).focus(function(){$("#output_"+u).val("")}),s&&a&&($("#submit_"+u).keydown(function(e){13===e.keyCode&&($(this).trigger("click",!0),e.preventDefault())}),$("#submit_"+u).click(function(){var e=$("#input_"+u).val();e=e.replace(/^\s+/,""),e=e.replace(/\s+$/,"");var t=r.test(e);gcbActivityAudit({index:n,type:"activity-freetext",value:e,correct:t}),t?($("#output_"+u).val(s),$("#output_"+u).focus()):($("#output_"+u).val(a),$("#output_"+u).focus())})),i&&$("#skip_and_show_"+u).click(function(){var e=$("#input_"+u).val();gcbActivityAudit({index:n,type:"activity-freetext",value:e,correct:null}),$("#output_"+u).val(i),$("#output_"+u).focus()})}function renderActivity(e,t){$.each(e,function(e,n){"string"==typeof n?t.append(n):"multiple choice"==n.questionType?generateMultipleChoiceQuestion(n,t,e):"multiple choice group"==n.questionType?generateMultipleChoiceGroupQuestion(n,t,e):"freetext"==n.questionType?generateFreetextQuestion(n,t,e):alert("Error in renderActivity: e.questionType is not in {'multiple choice', 'multiple choice group', 'freetext'}")})}function renderAssessment(e,t){function n(t){$("#answerOutput").html("");var n=0,r=[],s=[],a=[],i=0,c=0;$.each(e.questionsList,function(e,t){var o=0,u=!1,l=t.weight||1;if(c+=l,t.choices){for(var p=!1,d=document.assessment["q"+e],b=0;b<d.length;b++)if(d[b].checked){u="correct"==d[b].value,t.choiceScores&&t.choiceScores.length==d.length?o=t.choiceScores[b]:u&&(o=1,n++),p=!0,a.push({index:e,type:"choices",value:b,correct:u});break}p||a.push({index:e,type:"choices",value:null,correct:u})}else if(t.correctAnswerString){var m=$("#q"+e).val();m=m.replace(/^\s+/,""),m=m.replace(/\s+$/,""),u=m.toLowerCase()==t.correctAnswerString.toLowerCase(),u&&(o=1,n++),a.push({index:e,type:"string",value:m,correct:u})}else if(t.correctAnswerRegex){var m=$("#q"+e).val();m=m.replace(/^\s+/,""),m=m.replace(/\s+$/,""),u=t.correctAnswerRegex.test(m),u&&(o=1,n++),a.push({index:e,type:"regex",value:m,correct:u})}else if(t.correctAnswerNumeric){var g=parseFloat($("#q"+e).val()),v=.001;t.correctAnswerNumeric-v<=g&&g<=t.correctAnswerNumeric+v&&(u=!0,o=1,n++),a.push({index:e,type:"numeric",value:g,correct:u})}r.push(o*l),i+=o*l,!u&&t.lesson&&s.push(t.lesson)});var o=e.questionsList.length,u=(i/c*100).toFixed(2),l=getParamFromUrlByName("name")||"unnamed assessment",p=!t&&assessmentGlobals.isReviewForm;if((assessmentGlobals.isReviewForm||"human"!=assessmentGlobals.grader||window.confirm(trans.SUBMIT_ASSIGNMENT_CONFIRMATION+trans.CONFIRMATION_EXPLANATION))&&(!assessmentGlobals.isReviewForm||p||window.confirm(trans.SUBMIT_REVIEW_CONFIRMATION+trans.CONFIRMATION_EXPLANATION)))if(t||p){var d=document.createElement("form");d.method="post",d.action=assessmentGlobals.isReviewForm?"review":"answer";var b=null;b=document.createElement("input"),b.setAttribute("name","assessment_type"),b.setAttribute("value",l),d.appendChild(b),b=document.createElement("input"),b.setAttribute("name","score"),b.setAttribute("value",u),d.appendChild(b),b=document.createElement("input"),b.setAttribute("name","answers"),b.setAttribute("value",JSON.stringify(a)),d.appendChild(b),b=document.createElement("input"),b.setAttribute("name","xsrf_token"),b.setAttribute("value",assessmentXsrfToken),d.appendChild(b),assessmentGlobals.isReviewForm&&(b=document.createElement("input"),b.setAttribute("name","key"),b.setAttribute("value",assessmentGlobals.key),d.appendChild(b),b=document.createElement("input"),b.setAttribute("name","unit_id"),b.setAttribute("value",assessmentGlobals.unitId),d.appendChild(b),b=document.createElement("input"),b.setAttribute("name","is_draft"),b.setAttribute("value",p),d.appendChild(b)),document.body.appendChild(d),d.submit(),document.body.removeChild(d)}else{gcbAssessmentAudit({type:"assessment-"+l,values:a,num_expected:o,num_submitted:a.length,num_correct:n});var m=trans.YOUR_SCORE_TEXT+" "+u+"% ("+i.toFixed(0)+"/"+c+").\n\n";s.length>0&&(m+=trans.LESSONS_TO_REVIEW_TEXT+": "+s.join(", ")+"\n\n"),m+=u>=100?trans.PERFECT_SCORE_SAVE_TEXT:trans.GENERIC_SAVE_TEXT,$("#answerOutput").html(m)}}t.html('<form name="assessment"></form>'),t=t.find("form"),e.preamble&&t.append(e.preamble);var r=$("<ol></ol>");if(t.append(r),$.each(e.questionsList,function(e,t){r.append("<li></li>");var n=r.find("li:last");n.append(t.questionHTML),n.append("<p/>");var s=null;if(assessmentGlobals.savedAnswers&&e<assessmentGlobals.savedAnswers.length&&(s=assessmentGlobals.savedAnswers[e]),t.choices)$.each(t.choices,function(t,r){var a="q"+e+"-"+t,i="";null!==s&&t==s&&(i=" checked=true "),"string"==typeof r?n.append('<input type="radio" name="q'+e+'" id="'+a+'" '+i+' >&nbsp;<label for="'+a+'">'+r+"</label><br>"):("correct"!=r[0]&&alert("Error: Malformed question."),n.append('<input type="radio" name="q'+e+'" id="'+a+'" '+i+' value="correct">&nbsp;<label for="'+a+'">'+r[1]+"</label><br>"))});else if(t.correctAnswerString||t.correctAnswerRegex||t.correctAnswerNumeric)if("multiLine"in t&&t.multiLine){n.append("Answer:<br>");var a=$('<textarea id="q'+e+'" style="width: 100%" rows="7"></textarea>');null!=s&&a.text(s),n.append(a)}else{n.append("Answer:&nbsp;&nbsp;");var i=$('<input type="text" class="alphanumericOnly" style="border-style: solid; border-color: black; border-width: 1px;" id="q'+e+'" size="50">');null!==s&&i.val(s),n.append(i)}else alert("Error: Invalid question type.");n.append("<br><br>")}),assessmentGlobals.isReviewForm)t.append('<br><button type="button" class="gcb-button" id="saveDraftBtn">'+trans.SAVE_DRAFT_TEXT+'</button>&nbsp;&nbsp;<button type="button" class="gcb-button" id="submitAnswersBtn">'+trans.SUBMIT_REVIEW_TEXT+"</button>");else{e.checkAnswers&&(t.append('<button type="button" class="gcb-button" id="checkAnswersBtn">'+trans.CHECK_ANSWERS_TEXT+"</button><p/>"),t.append('<p/><textarea style="width: 600px; height: 120px;" readonly="true" id="answerOutput"></textarea>'));var s=trans.SUBMIT_ANSWERS_TEXT;"human"==assessmentGlobals.grader&&(s=trans.SUBMIT_ASSIGNMENT_TEXT);var a=transientStudent?' disabled="true" ':"";t.append('<br><button type="button" class="gcb-button" id="submitAnswersBtn" '+a+">"+s+"</button>")}$("#checkAnswersBtn").click(function(){n(!1)}),$("#saveDraftBtn").click(function(){n(!1)}),$("#submitAnswersBtn").click(function(){n(!0)})}function correct(e){return["correct",e]}function checkText(e,t){var n=document.getElementById(e).value;return n=n.replace(/^\s+/,""),n=n.replace(/\s+$/,""),t.test(n)}var gcbBeginningOfTime=new Date,highlightColor="#3BB9FF",globallyUniqueTag=0,gcbCanPostTagEvents=!1,gcbCanPostPageEvents=!1,gcbCanPostEvents=!1,eventXsrfToken="",assessmentXsrfToken="";$(document).ready(function(){function e(e){var e=e||event||null,t=e.target||e.srcElement||null;return 13==e.keyCode&&"text"==t.type?!1:void 0}try{gcbPageEventAudit({},"enter-page")}catch(t){}$("#lessonNotesLink").click(function(e){return gcbPageEventAudit({href:e.target.href},"click-link"),!0}),"undefined"!=typeof activity?renderActivity(activity,$("#activityContents")):"undefined"!=typeof assessment&&renderAssessment(assessment,$("#assessmentContents")),$(document).keypress(e)}),$(window).unload(function(){try{gcbPageEventAudit({duration:new Date-gcbBeginningOfTime},"exit-page")}catch(e){}});